stages:
  - build

variables: &variables
  # Build parameters. We later override them at job level if needed.
  SONAR_SCANNER: "OFF"
  COVERALLS: "OFF"
  RUN_TESTS: "ON"
  STOCK_CPPZMQ: "ON"
  USE_PCH: "ON"
  CMAKE_BUILD_TYPE: "Debug"
  TANGO_USE_USING_NAMESPACE: "ON"
  BUILD_SHARED_LIBS: "ON"

test-windows:
  variables:
    <<: *variables
    RUN_TESTS: "OFF"
  tags:
  - shared-windows
  - windows
  - windows-1809
  stage: build
  before_script:
     - Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1"
     - choco install -y miniconda3 --params="'/AddToPath:1'"
     - RefreshEnv
     - conda config --add channels conda-forge
     - conda init powershell
     - "if (test-path $PROFILE.CurrentUserAllHosts) { & $PROFILE.CurrentUserAllHosts}"
     - conda install -y cmake==3.20.1 omniorb==4.2.4 cppzmq==4.7.1 zeromq==4.3.2 tango-idl pthreads-win32
  script:
    - md build
    - cd build
    - >
      cmake
      -DBUILD_SHARED_LIBS=ON
      -DUSE_PCH=ON
      -DCMAKE_BUILD_TYPE=Release
      -DTANGO_INSTALL_DEPENDENCIES=OFF
      -DCMAKE_VERBOSE_MAKEFILE=ON
      -DCPPZMQ_BASE="C:\tools\miniconda3\Library\"
      -DIDL_BASE="C:\tools\miniconda3\Library\"
      -DOMNI_BASE="C:\tools\miniconda3\Library\"
      -DZMQ_BASE="C:\tools\miniconda3\Library\"
      -DTANGO_JPEG_MMX=OFF
      -DBUILD_TESTING=OFF
      ..
    - cmake --build . --config Debug
    - cpack -C Debug -G WIX
    - cpack -C Debug -G ZIP
  artifacts:
    paths:
      - build/*.zip
      - build/*.msi
